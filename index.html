<body style="background: white"></body>
<script src="https://cdn.jsdelivr.net/gh/netizenorg/netnet-standard-library/build/nn.min.js"></script>
<script src="https://unpkg.com/tone"></script>
<script src="https://algorithmicmusic.online/js/viz-helpers.js"></script>
<script>
/* global nn, Tone, viz */
// SOUND SOURCES + AUDIO GRAPH
// ---------------------------
// (your instruments and signal chain)  

const cowbell_file = "cumbia-cowbell.mp3"
const guiro_file = "guiro-cumbia.mp3"
const timbal_file = "timbal-cumbia-short.mp3"
const guitar_file = "cumbia-slapped-bass-guitar-D_minor.mp3"

const instruments = new Tone.Players({
  cowbell: cowbell_file,
  guiro: guiro_file,
  timbal: timbal_file,
  guitar: guitar_file
}).toDestination()
  
// SETTING UP TONE TRANSPORT
// --------------------------
let seq
let pattern = []
let cuts = []
Tone.Transport.loop = true // loop the transport
Tone.Transport.bpm.value = nn.randomInt(90, 300) // set your tempo/speed
Tone.Transport.timeSignature = 4 // beats per measure/bar
Tone.Transport.loopEnd = '2m' // how many measures/bars


// FUNCTIONS
// ----------

function toggle () {
  if (Tone.Transport.state === 'stopped') {
    Tone.Transport.start()
    this.content('stop')
  } else {
    Tone.Transport.stop()
    this.content('start') // change button's text
  }
}

function updateBPM () {
  Tone.Transport.bpm.value = this.value
}

//select randint, apply it using this func?
function updatePatternAndCuts(bar, beat) {
  pattern[bar][beat] = nn.randomInt(1)
  
  cuts[bar][beat] = {
    offset: nn.random(0, guiro.buffer.duration),
    duration: 60 / Tone.Transport.bpm.value
  }
}
  
function randomizePattern() {
  //stopping Transport = stop loops/sequence 
  Tone.Transport.stop()
  toggleButton.content('start')
  
  for (let inst in instruments) {
    instruments.player(inst).stop()
  }
  
  nn.times(2, m=> { //looping like a double for loop
    pattern[m] = []
    cuts[m] = []
    nn.times(4, b => updatePatternAndCuts(m, b))
  })
  //choosing random components!!
  //random beats per minute (bpm)
  Tone.Transport.bpm.value = nn.randomInt(90, 300)
  
  //random pace (playback rate)

  for (let inst in instruments) {
    instruments.player(inst).playbackRate = nn.random(0.25, 1.25)
  }
  //how does this update UI?
}
function play (time) {
  // we can check the current beat with: Tone.Transport.position
  // and we can convert position to an array of numbers like this
  const pos = Tone.Transport.position.split(':').map(Number)
  const bar = pos[0]
  const beat = pos[1]
  
  const val = pattern[bar][beat]
  const cut = cuts[bar][beat]
  
  //play
  for (const inst in instruments) {
    const val = patten[bar][beat]
    const cut = cuts[bar][beat]
    if (val) instruments.player(inst).start(time, cut.offset, cut.duration)
  }

  // update the label (for refernce)
  beatLabel.content(`measure: ${bar}, beat: ${beat}`)
  
  // DECIDE WHAT/WHEN TO PLAY HERE
  // ...
}

new Tone.Loop(play).start()

// USER INTERFACE
// ----------------
nn.create('button')
  .content('randomize')
  .addTo('body')
  .on('click',
     randomizePattern)
let toggleButton = nn.create('button')
  .content('start')
  .addTo('body')
  .on('click', toggle)

let bpmInput = nn.create('input')
  .set('type', 'number')
  .set('value', Tone.Transport.bpm.value)
  .addTo('body')
  .on('change', updateBPM)

nn.create('br').addTo('body')

const beatLabel = nn.create('label')
  .content('measure, beat')
  .addTo('body')

</script>